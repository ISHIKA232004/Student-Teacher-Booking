<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Dashboard</title>
    <link rel="stylesheet" href="../css/style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>

<body>
<div class="container">

    <!-- Navigation -->
    <nav class="navbar">
        <div class="logo">üìö Student Dashboard</div>
        <div class="nav-links">
            <span id="userWelcome" style="color: white; margin-right: 20px;"></span>
            <a href="#" onclick="logoutUser()">Logout</a>
        </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard">

        <!-- User Info -->
        <div class="user-info">
            <h2>Welcome, <span id="userName"></span>!</h2>
            <p>Student ID: <span id="userId"></span></p>
            <p>Email: <span id="userEmail"></span></p>
        </div>

        <!-- Tabs -->
        <div class="tabs" style="margin-bottom: 30px; display: flex; gap: 10px;">
            <button class="btn btn-primary" onclick="showTab('bookAppointment', this)">Book Appointment</button>
            <button class="btn btn-secondary" onclick="showTab('myAppointments', this)">My Appointments</button>
            <button class="btn btn-secondary" onclick="showTab('findTeachers', this)">Find Teachers</button>
        </div>

        <!-- Tab 1 -->
        <div id="bookAppointment" class="tab-content">
            <h3>Book New Appointment</h3>

            <div class="form-container" style="max-width: 100%;">
                <div class="form-group">
                    <label>Select Teacher:</label>
                    <select id="teacherSelect" class="form-control">
                        <option value="">Loading teachers...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Date:</label>
                    <input type="date" id="appointmentDate" class="form-control"
                           min="2024-01-01" max="2024-12-31" value="2024-01-15">
                </div>

                <div class="form-group">
                    <label>Time:</label>
                    <input type="time" id="appointmentTime" class="form-control">
                </div>

                <div class="form-group">
                    <label>Purpose of Meeting:</label>
                    <textarea id="purpose" class="form-control" rows="3"
                              placeholder="Briefly describe what you want to discuss"></textarea>
                </div>

                <button class="btn btn-success" onclick="bookNewAppointment()">Book Appointment</button>
            </div>
        </div>

        <!-- Tab 2 -->
        <div id="myAppointments" class="tab-content" style="display: none;">
            <h3>My Appointments</h3>
            <div class="table-container">
                <table id="appointmentsTable">
                    <thead>
                    <tr>
                        <th>Teacher</th>
                        <th>Date</th>
                        <th>Time</th>
                        <th>Purpose</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody id="appointmentsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Tab 3 -->
        <div id="findTeachers" class="tab-content" style="display: none;">
            <h3>Available Teachers</h3>
            <div class="features" id="teachersList"></div>
        </div>
    </div>

    <footer>
        <p>Student Dashboard &copy; 2024</p>
    </footer>
</div>

<!-- JS files -->
<script src="../js/firebase-config.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/appointments.js"></script>

<script>
    
/* DEBUG DB */
async function checkDatabaseConnection() {
    console.log("üîç Checking database connection...");
    try {
        const testQuery = await db.collection("users").limit(1).get();
        console.log("‚úÖ Database connection successful!");
        console.log("Total users:", testQuery.size);

        const allUsers = await db.collection("users").get();
        allUsers.forEach(doc => {
            console.log(`- ${doc.id}: ${doc.data().name} (${doc.data().type})`);
        });
    } catch (e) {
        console.error("‚ùå Database connection failed:", e);
    }
}

document.addEventListener("DOMContentLoaded", function () {
    checkDatabaseConnection();
    checkAuth();
    loadUserInfo();
    loadTeachersForDropdown();
    loadMyAppointments();
    showTab('bookAppointment');
});

function checkAuth() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.type !== "student") {
        alert("Please login first!");
        window.location.href = "login.html";
        return false;
    }
    return true;
}

function loadUserInfo() {
    const user = JSON.parse(localStorage.getItem("user"));
    if (user) {
        userWelcome.textContent = "Hello, " + user.name;
        userName.textContent = user.name;
        userEmail.textContent = user.email;
        userId.textContent = user.uid.substring(0,8) + "...";
    }
}

function showTab(tabName, btn) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.style.display = 'none');
    document.getElementById(tabName).style.display = 'block';

    document.querySelectorAll('.tabs button').forEach(b => {
        b.classList.remove('btn-primary');
        b.classList.add('btn-secondary');
    });

    if (btn) {
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-primary');
    }
        if (tabName === 'findTeachers') {
        loadTeachersForList();
    }
}

async function loadTeachersForDropdown() {
    const select = document.getElementById("teacherSelect");
    select.innerHTML = '<option value="">Select a teacher</option>';

    const snapshot = await db.collection("users")
        .where("type", "==", "teacher")
        .get();

    snapshot.forEach(doc => {
        const t = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = `${t.name} - ${t.subject || "Teacher"} (${t.department || "General"})`;
        select.appendChild(opt);
    });

    console.log(`‚úÖ Loaded ${snapshot.size} teachers`);
}
async function loadTeachersForList() {
    const listDiv = document.getElementById("teachersList");
    listDiv.innerHTML = "";

    try {
        const snapshot = await db.collection("users")
            .where("type", "==", "teacher")
            .get();

        if (snapshot.empty) {
            listDiv.innerHTML = "<p>No teachers available.</p>";
            return;
        }

        snapshot.forEach(doc => {
            const t = doc.data();
            listDiv.innerHTML += `
                <div class="teacher-card">
                    <h4>${t.name}</h4>
                    <p>Subject: ${t.subject || "N/A"}</p>
                    <p>Department: ${t.department || "N/A"}</p>
                </div>
            `;
        });

    } catch (e) {
        console.error("Error loading teachers list:", e);
        listDiv.innerHTML = "<p>Error loading teachers.</p>";
    }
}

async function bookNewAppointment() {
    const teacherId = teacherSelect.value;
    const date = appointmentDate.value;
    const time = appointmentTime.value;
    const purposeText = purpose.value;

    if (!teacherId || !date || !time || !purposeText) {
        alert("Please fill all fields!");
        return;
    }

    const result = await bookAppointment(teacherId, {
        date,
        time,
        purpose: purposeText
    });

    alert(result.message);
    loadMyAppointments();
}

async function loadMyAppointments() {
    const result = await getMyAppointments();
    const tbody = document.getElementById("appointmentsBody");

    // ‚≠ê VERY IMPORTANT ‚Äì clear table first
    tbody.innerHTML = "";

    if (!result.success || !result.appointments || result.appointments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align:center; padding:30px;">
                    No appointments found.
                </td>
            </tr>
        `;
        return;
    }

    result.appointments.forEach(appointment => {
        const row = document.createElement("tr");

        row.innerHTML = `
            <td>${appointment.teacherId.substring(0, 8)}...</td>
            <td>${appointment.date}</td>
            <td>${appointment.time}</td>
            <td>${appointment.purpose}</td>
            <td>
                <span class="status-badge ${appointment.status}">
                    ${appointment.status.toUpperCase()}
                </span>
            </td>
            <td>
                <button class="btn btn-primary btn-sm"
                    onclick="viewAppointment('${appointment.id}')">
                    View
                </button>
            </td>
        `;

        tbody.appendChild(row);
    });
}
function viewAppointment(id) {
    alert("Viewing appointment: " + id);
}
</script>

<style>
.status-badge {
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
}
.btn-sm {
    padding: 5px 15px;
}
</style>

</body>
</html>
